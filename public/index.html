
<html>
<head>
    <!-- Importing a-frame !-->
    <script src="aframe.min.js"></script>

    <!-- Importing other components !-->
    <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v3.8.0/dist/aframe-extras.min.js"></script>
    <script src="assets/scripts/aframe-controller-cursor-component.min.js"></script>
    <script src="assets/scripts/aframe-look-at-component.min.js"></script>
</head>
<body>
  <a-scene physics-world="gravity: 0 -3.8 0">
    <!-- We load the assets for the game !-->
    <a-assets>
      <!-- Background video !-->
      <video id="video" src="assets/background.mp4" autoplay loop muted preload="auto"></video>

      <!-- Pickup assets !-->
      <a-asset-item id="pickup-obj" src="assets/models/pickup/pickup_truck.obj"></a-asset-item>
      <a-asset-item id="pickup-mtl" src="assets/models/pickup/pickup_truck.mtl"></a-asset-item>

      <!-- Zombie0 asset !-->
      <a-asset-item id="zombie0-obj" src="assets/models/zombie/zombie_slow.obj"></a-asset-item>
      <a-asset-item id="zombie0-mtl" src="assets/models/zombie/zombie_slow.mtl"></a-asset-item>
        
      <!-- Zombie1 asset !-->
      <a-asset-item id="zombie1-obj" src="assets/models/zombie2/zombie.obj"></a-asset-item>
      <a-asset-item id="zombie1-mtl" src="assets/models/zombie2/zombie.mtl"></a-asset-item>
        

      <!-- Audio asset !-->
      <audio id="laserFire" src="assets/sounds/Laser-sound.mp3" preload="auto"></audio>
      <audio id="truckDriving" src="assets/sounds/truck-sound3.mp3" preload="auto"></audio>
      <audio id="zombieMoaning" src="assets/sounds/zombie-sound.mp3" preload="auto"></audio>
      <audio id="scratchSound" src="assets/sounds/scrach-full-sound.mp3" preload="auto"></audio>
        
    </a-assets>

     <!-- We add the controllers !-->
    <a-entity id="leftHand" position="0 2 -2" hand-controls="left"></a-entity>
    <a-entity id="rightHand" position="0 2 -2" hand-controls="right" controller-cursor raycaster="objects: .pickable, .enemy"></a-entity>

    <a-camera position="0 2 -2" sound="src: #scratchSound;"></a-camera>
    <a-videosphere src="#video" rotation="0 90 0"></a-videosphere>
    <a-entity id="ground" geometry="primitive: box; depth: 50; height: 0.1; width: 30" material="color: #2E3837" physics-body="mass: 0; boundingBox: 50 0.1 50" position="0 0 -10" visible="false"></a-entity>

    <!-- Truck !-->
    <a-obj-model class="truck" sound="src: #truckDriving; autoplay: true; loop: true;" position="0 0 3" src="#pickup-obj" mtl="#pickup-mtl">
      <a-text color="red" class="score" value="Score: 0" position="0.520 2.159 -5.546"></a-text>
      <a-text color="red" class="life" value="Life: 5" position="-1.354 2.159 -5.546"></a-text>
    </a-obj-model>
    
    <a-entity id="laserGun" class="pickable" scale="1 1 1" position="0.038 2.834 -2" object-model="src:url(assets/models/gun/ablast/gun.json)" sound="src: #laserFire; poolSize: 2000;" rotation="60.07000000000001 0 0"></a-entity>
      
    <a-entity id="instruction" position="2 10 -20"
              text="width: 20; lineHeight: 100; letterSpacing: 5; color: red; value: Objection : Search a gun and pick it.">
    </a-entity>
  </a-scene>

  <!-- Browserified source !-->
  <!-- <script src="core/bundled.js"></script> -->

  <script type="text/javascript">
    // Game status: true means playing.
    var playingGame = false;

    window.addEventListener("load", function(){
      const SCENE             = document.querySelector("a-scene");
      const RIGHT_CONTROLLER  = document.querySelector("#rightHand");
      const TRUCK             = document.querySelector(".truck");
      const PLAYER            = document.querySelector("a-camera");

      var pickedGun     = null;
      var targetEnemy   = null;
      var score         = 0;
      var life          = 5;

      // Moving the truck
      setInterval(function(){
        TRUCK.setAttribute("rotation", Math.random() + " 0 0");
        var ennemies = document.querySelectorAll(".enemy");
      },100);
        
      // Spawning zombie function
      setInterval(function(){
        if(!playingGame) return;
        var ennemies = document.querySelectorAll(".enemy");
        for(var i = 0; i < ennemies.length; i++) {
          var enemyPosition = ennemies[i].components.position.data;

          (enemyPosition.z >= -2) ? reduceLife() : enemyPosition.z += 1;
          if(enemyPosition.z >= -2) continue;

          ennemies[i].setAttribute("position", enemyPosition);
          ennemies[i].components.position.update();
        }

        if(ennemies.length === 10) return;

        createNewEnemy();
      }, 3000)

      // Grab the gun
      RIGHT_CONTROLLER.addEventListener('click', function(evt) {
        if(evt.detail.intersectedEl === undefined) return; 
        if(evt.detail.intersectedEl.className !== "pickable") return;
        if(pickedGun !== null) return; 

        pickedGun = evt.detail.intersectedEl;
        SCENE.removeChild(pickedGun);
        RIGHT_CONTROLLER.appendChild(pickedGun);
        pickedGun.setAttribute("class", "");
        pickedGun.setAttribute("position", "0.013 0.005 -0.054");
        pickedGun.setAttribute("rotation", "-3.552 59.702 91.616");

        updateInstruction('Objection : Kill All Zombies');
        generateStartPoint();
      });

      // Define if the player is targeting a zombie
      RIGHT_CONTROLLER.addEventListener("mouseenter", function(evt) {
        if(evt.detail.intersectedEl === undefined) return;
        else if(evt.detail.intersectedEl.className === "enemy" ) {
          targetEnemy = evt.detail.intersectedEl;
          playingGame = true;
          updateInstruction('Objection : Kill All Zombies');
        }
      })

      // Define if the player is no more targeting a zombie
      RIGHT_CONTROLLER.addEventListener("mouseleave", function(evt) {
        if(targetEnemy === null) return;

        targetEnemy = null;
      })

      // When player shoot, kill the zombie or do nothing;
      RIGHT_CONTROLLER.addEventListener('triggerdown', function(evt) {
        if(pickedGun === null) return; 

        document.querySelector('[sound]').components.sound.playSound();
        if(targetEnemy === null) return;
        SCENE.removeChild(targetEnemy);
        score += 10;
        document.querySelector("a-text").setAttribute("value", "Score: " + score);
        targetEnemy = null;
      })

      // Starting game
      function generateStartPoint() {
        createNewEnemy();
      }

      // Reduce life of the player
      function reduceLife() {
        if(life === 0) return CallGameOver();
        var lifeText = document.querySelector(".life");

        PLAYER.components.sound.playSound();

        life--;
        lifeText.setAttribute("value", "Life: " + life);
        return true;
      }

      function createNewEnemy() {
        var rand    = Math.floor(Math.random() * 2);
        var zombie  = document.createElement("a-obj-model");
        zombie.setAttribute("class","enemy");
        zombie.setAttribute("position", Math.floor((Math.random() * 5) + 1) + " 0 -" + Math.floor((Math.random() * 10) + 2));
        zombie.setAttribute("scale","1.6 2 1.6");
        zombie.setAttribute("src","#zombie"+ rand +"-obj");
        zombie.setAttribute("mtl","#zombie"+ rand +"-mtl");
        if(rand == 1){
            zombie.setAttribute("rotation","0 -100 0");
        }
        zombie.setAttribute("look-controls","");
        zombie.setAttribute("sound","src: #zombieMoaning; autoplay: true;");
        SCENE.appendChild(zombie);
      }

      // Create a game over function.
      function CallGameOver() {
        removeAllEnemies();
        playingGame = false;
        life = 5;
        score = 0;
        document.querySelector(".life").setAttribute("value", "Life " + life);
        document.querySelector("a-text").setAttribute("value", "Score: " + score);
        updateInstruction('Are you Giving up? Kill zombie!');
        createNewEnemy();
      }

      function removeAllEnemies() {
        var enemies = document.querySelectorAll('.enemy'); 
        for(var i = 0; i < enemies.length; ++i) {
          SCENE.removeChild(enemies[i]);
        }
      }
      // Update Text.
      function updateInstruction(newText) {
        var instruction = document.getElementById('instruction');
        instruction.setAttribute('text', 'value', newText);
      }

    });

    // Animate opacity.
    var instruction = document.getElementById('instruction');
    var obj = {opacity: 0};
    var tween = new AFRAME.TWEEN.Tween(obj)
      .to({opacity: 1}, 500)
      .repeat( Infinity )
      .yoyo( true )
      .onUpdate(function () {
        instruction.setAttribute('text', 'opacity', obj.opacity);
      })
      .start();
    </script>
</body>
</html>
